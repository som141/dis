name: CI-CD Deploy (Blue-Green)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

# GITHUB_TOKEN 최소 권한(원칙)
permissions:
  contents: read

# 동시 배포 방지(같은 브랜치에 연속 push 시 꼬임 방지)
concurrency:
  group: dis-deploy-main
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      APP_NAME: dis-bot
      DEPLOY_DIR: /home/ubuntu/dis-deploy

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Build with Gradle (test + shadowJar)
        run: |
          chmod +x ./gradlew
          ./gradlew clean test shadowJar --no-daemon

      - name: Build Docker image
        run: |
          docker build -t "${APP_NAME}:${{ github.sha }}" .

      - name: Save Docker image to tar.gz
        run: |
          mkdir -p out
          docker save "${APP_NAME}:${{ github.sha }}" | gzip > "out/${APP_NAME}-${{ github.sha }}.tar.gz"

      - name: Create .env file for server (TOKEN only)
        env:
          TOKEN: ${{ secrets.TOKEN }}
        run: |
          mkdir -p out
          # 파일 내용은 로그에 출력하지 않음
          printf "TOKEN=%s\n" "${TOKEN}" > out/.env.cicd

      - name: Prepare SSH key and known_hosts
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          mkdir -p ~/.ssh
          echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # 호스트키 등록(간편하지만 MITM 위험이 있을 수 있으니 운영에서는 고정 known_hosts 권장)
          ssh-keyscan -p "${SSH_PORT}" "${SSH_HOST}" >> ~/.ssh/known_hosts

      - name: Ensure remote directories exist
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          ssh -p "${SSH_PORT}" -i ~/.ssh/id_ed25519 "${SSH_USER}@${SSH_HOST}" \
            "mkdir -p '${DEPLOY_DIR}/incoming'"

      - name: Upload (image tar.gz + .env.cicd)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          scp -P "${SSH_PORT}" -i ~/.ssh/id_ed25519 \
            "out/${APP_NAME}-${{ github.sha }}.tar.gz" \
            "${SSH_USER}@${SSH_HOST}:${DEPLOY_DIR}/incoming/"

          scp -P "${SSH_PORT}" -i ~/.ssh/id_ed25519 \
            "out/.env.cicd" \
            "${SSH_USER}@${SSH_HOST}:${DEPLOY_DIR}/incoming/.env.cicd"

      - name: Remote deploy
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          ssh -p "${SSH_PORT}" -i ~/.ssh/id_ed25519 "${SSH_USER}@${SSH_HOST}" \
            "bash '${DEPLOY_DIR}/scripts/deploy.sh' '${{ github.sha }}'"
